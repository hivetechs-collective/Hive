#!/bin/bash
# HiveTechs Consensus Pre-Removal Script

set -e

case "$1" in
    remove|upgrade|deconfigure)
        # Stop systemd service if running
        if command -v systemctl >/dev/null 2>&1; then
            systemctl stop hive.service 2>/dev/null || true
            systemctl disable hive.service 2>/dev/null || true
        fi
        
        # Backup user data before removal
        if [ -d /var/lib/hive ] && [ "$1" = "remove" ]; then
            echo "Creating backup of HiveTechs data..."
            timestamp=$(date +%Y%m%d_%H%M%S)
            backup_dir="/tmp/hive_backup_${timestamp}"
            mkdir -p "$backup_dir"
            cp -r /var/lib/hive/* "$backup_dir/" 2>/dev/null || true
            echo "Backup created at: $backup_dir"
            echo "You can restore this data if you reinstall HiveTechs Consensus."
        fi
        ;;
    
    failed-upgrade)
        ;;
    
    *)
        echo "prerm called with unknown argument \`$1'" >&2
        exit 1
        ;;
esac

exit 0